<!DOCTYPE html>
<html lang="en">
<head>
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
<meta http-equiv="Pragma" content="no-cache" />
<meta http-equiv="Expires" content="0" />
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, minimal-ui">
<meta http-equiv="X-UA-Compatible" content="IE=edge">

<title>Living PRISMA</title>
<link rel="icon" href="/static/img/favicon.png" type="image/png">
<!-- font awesome -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css" />
<!-- jquery ui -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.css" />
<!-- google font -->
<link href="https://fonts.googleapis.com/css?family=Roboto:100,300,400,500,700,900" rel="stylesheet">

<link href="https://cdn.jsdelivr.net/npm/@mdi/font@4.x/css/materialdesignicons.min.css" rel="stylesheet">


<style>
{% include 'css/box.css' %}
{% include 'css/start_screen.css' %}

html, body {
    width: 100%;
    height: 100%;
    padding: 0;
    margin: 0;
    overflow: hidden;
}
body {
    font-size: 12px;
    font-family: Arial, Helvetica, sans-serif;
}
p {
    margin: .1rem;
}
a {
    color: #333333;
    text-decoration: none;
}
.flex-container {
    display: flex;
    justify-content: flex-start;
    width: 100%;
    height: 100%;
}
/* element ui css */
.text-start {
    font-size: 10px;
}
.v-data-table td {
    font-size: .8rem;
}
/* layouts */
#wrapper {
    flex-direction: row;
}

/* app */
#app_prisma {
    width: 100%;
    height: 100%;
}
/* page */
.ss-box {
    position: absolute;
    width: 150px;
    /* height: 50px; */
    border: 1px solid #666666;
    padding: 5px;
    text-align: center;
    box-shadow: 3px 3px #cccccc;
    cursor: pointer;
    background-color: white;
}
.ss-box2 {
    border: 1px solid #ab7e3b;
    background-color: #fff9dc;
}
.ss-box2:hover {
    background: #fff9dc;
    box-shadow: 3px 3px #aaaaaa;
}
.ss-box3 {
    border-radius: 10px;
    border: 3px solid red;
}
.ss-info {
    /* max-height: 32px; */
    line-height: 15px;
    text-overflow: ellipsis;
    overflow: hidden;
    font-size: small;
}
.ss-box-stage {
    font-weight: normal;
}
.ss-box-stage:hover {
    font-weight: bold;
}
.ss-number {
    font-size: .9rem;
}
.ss-arrow {
    position: absolute;
    text-align: center;
    font-size: 2rem;
}
.ss-box-legend-text {
    margin-left: 30px;
    line-height: 10px;
    font-size: 11px;
    white-space: nowrap;
}
/* component */
.result-list-item {
    margin-bottom: 5px;
}
.result-list-item:hover,
.result-list-item:active {
    background-color: #eeeeee;
}
.study-badge {
    color: white;
    background: #6762df;
    padding: 0px 3px;
    border-radius: 5px;
}
.study-title {
    font-size: 1.1em;
    padding: 0 0 0 .2em;
    color: mediumblue;
}
.study-title:hover {
    color: blue;
}
.study-authors {
    padding: 0 0 0 .2em;
    font-size: .95em;
}
.study-pub {
    padding: 0 0 0 .2em;
    font-size: .9em;
}
.study-journal {
    font-weight: bold;
}
.study-pmid {
    color: gray;
}
.study-pmid:hover {
    color: darkblue;
    text-decoration: none;
}
.dialog p {
    font-size: 14px;
}

#initial_prisma {
    padding: 0 5px;
}
#initial_prisma svg {
    width: 100%;
}
#living_prisma {
    padding: 0 5px;
}
#living_prisma svg {
    width: 100%;
}
.prisma-dailouges {
    background: none;
    outline: none;
    border: 1px solid;
    padding: 12px 0px;
    width: 160px;
    color: white;
    cursor: pointer;
    background-color: #AB7E3B;
    transition: background-color 0.3s ease;
    box-shadow: 0 0px 7px rgb(0 0 0 / 0.2);
}
.prisma-dailouges:hover {
    background-color: #c79140;
}
.selected {
    border-color: #fff;
    font-weight: bold;
    background-color: #ce9949;
}
.date-picker {
    margin-top: 6px;
    padding: 6px 20px;
}
.input-group {
    position: absolute;
    visibility: hidden;
}
.e3-listing-box {
    position: absolute;
    bottom: 50%;
    left: 50%;
    transform: translateX(-50%) translateY(50%);
    border: 1px solid #c5c5c5;
    background: #fff;
    width: 400px;
}
.cross-box {
    width: 25px;
    height: 25px;
    background-color: #efefef;
    position: relative;
    display: flex;
    justify-content: center;
    align-items: center;
    margin-top: 6px;
    border-radius: 5px;
}

.cross-box::before {
    content: "Ã—";
    font-size: 24px;
    color: black;
}
.dialogue-header {
    border: 1px solid #ddd;
    background: #e9e9e9;
    color: #333;
    font-weight: bold;
    display: flex;
    justify-content: space-between;
    padding: 0px 10px;
}
#living_calender {
    margin: 10px auto;
}
.year {
    display: flex;
    flex-direction: row;
    align-items: center;
}
.year-label {
    width: 40px;
    padding: 5px 1em;
}
.year-box {
    display: flex;
    flex-direction: row;
    align-items: center;
}
.month-header {
    width: 25px;
    height: 10px;
    border: 1px solid transparent;
    margin-right: 5px;
    margin-bottom: 3px;
    text-align: center;
    color: #666666;
    font-size: 0.8em;
}
.month-item {
    width: 25px;
    height: 25px;
    border: 1px solid #f3f3f3;
    align-items: center;
    margin-right: 5px;
    text-align: center;

    display: flex;
    flex-direction: column;

    cursor: pointer;
}
.month-selected {
    background-color: #AB7E3B;
    color: white !important;
}
.month-na-item {
    width: 25px;
    height: 25px;
    border: 1px solid transparent;
    margin-right: 5px;
}
.month-item:hover {
    border: 1px solid #dfdfdf;
    background-color: #cfcfcf;
}
.month-item-a1-label {
    font-size: 0.7em;
    height: 0.9em;
}
.month-item-f1-na-label {
    color: #d0d0d0;
    font-size: 0.7em;
    height: 0.95em;
}
.month-item-f1-label {
    font-weight: bold;
    height: 0.95em;
}
.fw-bold {
    font-weight: bold;
}
</style>
</head>
<body>

<div id="start-screen">
    <h1>
        <i class="fa fa-table"></i>
        PRISMA Flow Diagram
    </h1>
    <div id="ss-msg">Initializing data and plot ...</div>
</div>

<div id="wrapper" 
    class="flex-container">

<div id="app_prisma"
    class="flex-container">


<div class="box" style="width: 900px; min-width: 900px;">

    <div class="d-flex" style="justify-content: center; padding: 0 5px; gap: 15px;">
        <button class="prisma-dailouges custom-prisma" 
            @click="showCustomPrisma();"
            :class="{ 'selected': selectedButton === 'original' }">
            Current State
        </button>
        <button class="prisma-dailouges initial-prisma"
            @click="showDatabasePrisma();"
            :class="{ 'selected': selectedButton === 'initial' }">
            Initial search
        </button>
        <button class="prisma-dailouges living-prisma" 
            @click="showResearchedPrisma()"
            :class="{ 'selected': selectedButton === 'living' }">
            Living search
        </button>
    </div>

    <div id="living_calender" v-if="selectedButton == 'living'">
        <div class="year">

            <div class="year-label">
                &nbsp;&nbsp;&nbsp;&nbsp;
            </div>
            <div class="year-box">
                <div v-for="m in 12"
                    class="month-header"
                    :class="{'fw-bold': m == active_month}">
                    {{ month_labels[m] }}
                </div>
            </div>
        </div>
        <div v-for="yp, year in raw.monthly_prisma"
            class="year">
            <div :class="{'fw-bold': year == active_year}"
                class="year-label">
                {{ year }}
            </div>
            <div class="year-box">
                <div v-for="m in 12"
                    @click="showYearMonthPrisma(year, m)"
                    :class="{'month-item': yp.hasOwnProperty(m), 'month-na-item': !yp.hasOwnProperty(m), 'month-selected': year == active_year && m == active_month}">
                    <template v-if="yp.hasOwnProperty(m)">
                        <span v-if="yp[m]['f1']['n'] > 0"
                            class="month-item-f1-label">
                            {{ yp[m]['f1']['n'] }}
                        </span>
                        <span v-else
                            class="month-item-f1-na-label">
                            &nbsp;
                        </span>

                        <span class="month-item-a1-label">
                            {{ yp[m]['a1']['n'] }}
                        </span>
                    </template>
                </div>
            </div>
        </div>
    </div>

    <div style="margin-top: 12px; display: none;">
        <div id="filters" class="wrapper input-group d-flex" style="justify-content: center;">
            <div class="year-picker">
                <select id="year" class="year-dropdown" onchange="callUpdateSvgYear(value)">
                    <option value="" selected >Select Year</option>
                </select>
            </div>
    
              &nbsp;&nbsp;&nbsp;
            <select  class="form-control" id="month-selected" name="" placeholder="Select Month " onchange="callUpdateSvgMonth(value)">
                <option value="" selected >Select Month</option>
            </select>
        </div>
    </div>

    <div id="initial_prisma" style="margin-top: 15px;">
        {% include 'svg/PRISMA_living_initial.svg' %}
    </div>

    <div id="living_prisma" v-if="researchedPrisma" style="margin-top: 15px;">
        {% include 'svg/PRISMA_living_living.svg' %}
    </div>

    <div id="custom_prisma" v-if="customPrisma" style="margin-top: 15px;">
        {% include 'svg/PRISMA_living_overall.svg' %}
    </div>


</div><!-- /#fg_prisma -->


<div id="tb_studylist" 
    class="box" 
    style="width: 600px; min-width: 600px; overflow-y: auto;">

    <div>
        <div class="box-header">
            <h4>
                <i class="fa fa-file"></i>
                Study List |
            </h4>
            <div>
                <p>{{ vals[stage].text }}</p>
            </div>
        </div>
    </div>

    <div>
        <div class="box-body" style="overflow-y: auto;"
            v-if="articlesList[stage].pids.length > 0">
            <p>
                <!-- {{ articlesList[stage].n_ctids }} clinical trials, 
                {{ articlesList[stage].n_pmids }} references -->
            </p>

            <div class="box-body-item result-list-item"
                v-for="pid, idx in articlesList[stage].pids">

                <div class="study-title" style="cursor: pointer;"
                    v-on:click="show_study_by_pmid(pid)">
                    <span class="study-badge">{{ idx + 1 }}</span>
                    {{ get_paper(pid).title }}
                </div>

                <div class="study-authors">
                    {{ get_paper(pid).authors }}
                </div>

                <div class="study-pub">
                    {{ get_paper(pid).date }} 
                    <span class="study-journal">
                        {{ get_paper(pid).journal }}
                    </span>. 
                    <a class="study-pmid" 
                        target="_blank" 
                        title="Show in PubMed" 
                        v-bind:href="getDynamicUrl(pid)">
                        {{ pid }}
                    </a>

                    <a class="study-pmid" 
                        target="_blank" 
                        title="Show clinical trial detail" 
                        v-bind:href="url.ctgov.view_ct + get_paper(pid).ctid">
                        {{ get_paper(pid).ctid }}
                    </a>
                </div>

            </div>

        </div>
    </div>

</div><!-- /#tbl_study -->

<div id="e3-close-dialogue" style="visibility: hidden;" class="e3-listing-box"  title="Excluded by full text review">
    <div class="dialogue-header">
        <h6>Excluded by full text review</h6>
        <button @click="closeE3Dialogue();" 
            id="e3-close-button" class="cross-box"></button>
    </div>
    <p style="padding: 10px 15px 0; margin: 0;">
    Full-text articles were excluded by the following reasons:
    </p>
    
    <div v-if="articlesList != null" style="padding: 10px 15px;">
        <ul>
            <li v-for="val, reason in articlesList.e3_by_reason">
                <b>{{ reason }}:</b> {{ val.n }}
            </li>
        </ul>
    </div>
</div>

</div>
<!-- /#app_prisma -->

</div>
<!-- /#wrapper -->

<div style="display:none;" id="data_pub">
[[j|safe]]
</div>

<!-- use third party libs -->
<script src="https://code.jquery.com/jquery-3.4.1.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/vue/2.6.10/vue.min.js"></script>
<!-- vuetify -->
<script src="https://cdn.jsdelivr.net/npm/vuetify@2.x/dist/vuetify.js"></script>
<!-- chance.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/alasql/0.5.5/alasql.min.js"></script>
<!-- Date Picker -->
<link href="https://netdna.bootstrapcdn.com/bootstrap/2.3.2/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.2.0/css/datepicker.min.css" rel="stylesheet">
        
<script src="https://netdna.bootstrapcdn.com/bootstrap/2.3.2/js/bootstrap.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.2.0/js/bootstrap-datepicker.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/moment.min.js"></script>
<!-- for IE -->
<script>
var isIE = /*@cc_on!@*/false || !!document.documentMode;
if (isIE) {
    document.getElementById('ss-msg').innerHTML = 'The functions used in this website require advanced web technologies, which are <b>NOT</b> supported by Internet Explorer<br>Try using Google Chrome, Apple Safari, Mozilla Firefox or other modern browsers.';
}
</script>
<script>

var prismaData;
var prismaYearFilter = '';
var prismaMonthFilter = '';
var prismaYearDropdownOptions = [];
var prismaMonthDropdownOptions = {};
var initialSvg = document.getElementById('initial_prisma').innerHTML;
var livingSvg = document.getElementById('living_prisma').innerHTML;
var customSvg = document.getElementById('custom_prisma').innerHTML;
var yearDropdown = document.getElementById("year");

var app_prisma = {
    vpp: null,
    vpp_id: '#app_prisma',

    url: {
        ctgov: {
            view_ct: 'https://clinicaltrials.gov/ct2/show/'
        },
        pubmed: {
            esearch: 'https://eutils.ncbi.nlm.nih.gov/entrez/eutils/esearch.fcgi?db=pubmed',
            esummary: 'https://eutils.ncbi.nlm.nih.gov/entrez/eutils/esummary.fcgi?db=pubmed',
            efetch: "https://eutils.ncbi.nlm.nih.gov/entrez/eutils/efetch.fcgi?db=pubmed",
            view_pmid: 'https://www.ncbi.nlm.nih.gov/pubmed/?term='
        },
    },

    init: function(data) {
        this.data = data;
        // init the data
        this.vpp = new Vue({
            el: this.vpp_id,
            data: { 
                // raw
                raw: data,
                
                // for prisma
                vals: this.data.prisma,

                // for paper
                paper_dict: this.data.paper_dict,

                // for study
                study_dict: this.data.study_dict,

                // for paging
                pn: 0,
                tp: 1,

                // for study list label?
                stage: 'f3',

                // what?
                url: this.url,

                // Prisma type selection
                databasePrisma: false,
                researchedPrisma: false,
                customPrisma: false,
                originalPrismaState: true,
                selectedButton: 'original',

                // monthly prisma articles flag
                monthlyPaperListFlag: false ,

                //articlesList
                articlesList: prismaData.prisma,

                //e3 dialogue flag
                e3ReasonsFlag: false,

                active_year: null,
                active_month: null,
                
                month_labels: {
                    1: 'JAN',
                    2: 'FEB',
                    3: 'MAR',
                    4: 'APR',
                    5: 'MAY',
                    6: 'JUN',
                    7: 'JUL',
                    8: 'AUG',
                    9: 'SEP',
                    10: 'OCT',
                    11: 'NOV',
                    12: 'DEC',
                }
            },
            methods: {
                getDynamicUrl(pid) {
                    const decimalPattern = /^10.*/;
                    if (decimalPattern.test(pid)) {
                        return 'https://doi.org/' + pid;
                    } else {
                        return this.url.pubmed.view_pmid + pid;
                    }
                },
                fmt_num: function(x) {
                    return x.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
                },

                update_study_list: function(stage) {
                    this.stage = stage;
                },

                show_excluded_studies: function(stage) {
                    if (stage == 'e3') {
                        $( "#dialog-message-e3" ).dialog( "open" );
                    }
                },

                closeE3Dialogue: function() {
                    document.getElementById('e3-close-dialogue').style.visibility = 'hidden';
                },

                show_study_by_pmid: function(pmid) {

                },
                
                prev_page: function() {
                    if (this.pn > 0) {
                        this.pn -= 1;
                        tb_search.search(
                            tb_search.vpp.keyword,
                            tb_search.vpp.pn * tb_search.retmax
                        );
                    }
                },

                next_page: function() {
                    if (this.pn < this.tp) {
                        this.pn += 1;
                        tb_search.search(
                            tb_search.vpp.keyword,
                            tb_search.vpp.pn * tb_search.retmax
                        );
                    }
                },

                show_study_by_pmid: function(pmid) {

                },

                get_paper: function(pid) {
                    if (this.paper_dict.hasOwnProperty(pid)) {
                        // good, just return this paper
                        return this.paper_dict[pid];

                    } else {
                        // that's weird, just return an empty record
                        return {
                            authors: "" + pid,
                            ctid: "" + pid,
                            date: "NA",
                            journal: "NA",
                            pid: pid,
                            pid_type: "NA",
                            title: ''
                        }
                    }
                },
                showDatabasePrisma: function() {
                    this.selectedButton = 'initial';
                    this.active_year = null;
                    this.active_month = null;
                    this.databasePrisma = true;
                    this.researchedPrisma = false;
                    this.originalPrismaState = false;
                    var filtersElement = document.getElementById("filters");
                    filtersElement.classList.add('input-group');
                    document.getElementById("initial_prisma").style.visibility = "visible";

                    // need to update f3 and e3_by_reason here
                    let prisma2 = JSON.parse(JSON.stringify(prismaData.prisma));
                    
                    // the f3 in init is a subset of original f3
                    let new_f3 = {
                        n_pmids: 0,
                        n_ctids: 0,
                        pids: [],
                        rcts: []
                    }
                    for (let i = 0; i < prisma2.f3.pids.length; i++) {
                        const pid = prisma2.f3.pids[i];
                        if (prisma2.f2.pids.indexOf(pid)>=0) {
                            new_f3.pids.push(pid);
                        }
                    }
                    for (let i = 0; i < prisma2.f3.rcts.length; i++) {
                        const rct = prisma2.f3.rcts[i];
                        if (prisma2.f2.rcts.indexOf(rct)>=0) {
                            new_f3.rcts.push(rct);
                        }
                    }
                    new_f3.n_pmids = new_f3.pids.length;
                    new_f3.n_ctids = new_f3.rcts.length;

                    // update f3
                    prisma2.f3 = new_f3;

                    // update e3i_by_reason
                    prisma2.e3_by_reason = prisma2.e3i_by_reason
                    this.articlesList = prisma2;
                    
                    // update svg using the new prisma
                    app_prisma.update_svg({
                        prisma: prisma2
                    });
                },
                showResearchedPrisma: function() {
                    this.selectedButton = 'living';
                    this.databasePrisma = false;
                    this.originalPrismaState = false;
                    var filtersElement = document.getElementById("filters");
                    var yearDropdown = document.getElementById("year");
                    var monthDropdown = document.getElementById("month-selected");
                    filtersElement.classList.remove('input-group');
                    yearDropdown.selectedIndex = 0;
                    monthDropdown.selectedIndex = 0;
                    document.getElementById("initial_prisma").style.visibility = "hidden";
                    app_prisma.update_svg(prismaData);
                },
                showCustomPrisma: function() {
                    this.selectedButton = 'original';
                    this.databasePrisma = false;
                    this.researchedPrisma = false;
                    this.originalPrismaState = true;
                    this.articlesList = prismaData.prisma;
                    var filtersElement = document.getElementById("filters");
                    filtersElement.classList.add('input-group');
                    app_prisma.update_svg(prismaData);
                    document.getElementById("initial_prisma").style.visibility = "visible";
                },

                showYearMonthPrisma: function(year, month) {
                    this.active_year = year;
                    this.active_month = month;

                    app_prisma.update_svg_by_year(
                        year, month
                    )
                }
            }
        });
        this.update_svg(data);
    },

    update_svg: function(data) {

        // update the svg
        var refs = [
            's0',
            'a2x',
            'a1',
            'b2',
            'w1',
            'b3',
            'b5',
            'e21',
            'e22',
            'e3',
            'f1',
            'f2',
            'f3',
            'm1',
            'u4',
            'u5',
            'u6',
            'u7',
            'u8',
            'u9',
            'u10',
            'u11',
            'u12',
            'u13',
            'u14',
            'u15',
            'u16',
            'u17',
            'u18',
            'u19',
            'u20'
        ];

        // replace the $$ with jquery findable tag
        var svgTxt;
        if(this.vpp.databasePrisma) {
            svgtxt = initialSvg;
        } else if(this.vpp.originalPrismaState) {
            svgtxt = customSvg;
        }
        else {
            svgtxt = livingSvg;
        }

        // local prisma
        var prisma = JSON.parse(JSON.stringify(data.prisma));

        for (let i = 0; i < refs.length; i++) {
            const ref = refs[i];
            // update the number
            // replace the prisma title

            if (prisma.hasOwnProperty(ref)) {
                // ok, found the value, 
                // the default value is from db
                var tmp = prisma[ref].n_pmids;

                // for f1 and f3, also need to show the nct
                if (ref == 'f1' || ref == 'f3' || ref=='f2') {
                    // also need to update the ct id
                    svgtxt = svgtxt.replace(
                        '$'+ref+'_ctids$', 
                        '' + jarvis.add_commas_to_number(prisma[ref].n_ctids)
                    );
                }

                // for others, need to update the number accordingly
                if (ref == 'b5') {

                   tmp = prisma.u6.n_pmids -  (prisma.u8.n_pmids + prisma.u9.n_pmids);
                          
                } 
                else if(ref == 'u11') {
                if(prisma.u11) {
                    tmp = prisma.s0.n_pmids + prisma.a1.n_pmids + prisma.a3x.n_pmids ;
                    console.log("*************************************")
                    console.log(ref)
                    console.log(tmp)
                    svgtxt = svgtxt.replace(
                        '$'+ref+'$', 
                        '' + jarvis.add_commas_to_number(tmp)
                    );
                }
                
            }
                else if (ref == 'b3') {
                    tmp = prisma.e3.n_pmids +
                          prisma.f1.n_pmids +
                          prisma.e21.n_pmids + 
                          prisma.e22.n_pmids;

                } else if (ref == 'b2') {
                    tmp = prisma.a1.n_pmids +
                          prisma.a2x.n_pmids;
                }

                // update the value 
                svgtxt = svgtxt.replace(
                    '$'+ref+'$', 
                    '' + jarvis.add_commas_to_number(tmp)
                );
            } else if (ref == 'w1') {
                // special rule for screening studies
                // it is b2 - b3
                tmp = (
                    prisma.a1.n_pmids +
                    prisma.a2x.n_pmids
                    ) 
                    - 
                    (
                    prisma.e3.n_pmids +
                    prisma.f1.n_pmids +
                    prisma.e21.n_pmids + 
                    prisma.e22.n_pmids
                    );

                svgtxt = svgtxt.replace(
                    '$'+ref+'$', 
                    '' + jarvis.add_commas_to_number(tmp)
                );
            } else if(ref == 'm1') {
                if(prisma.a3x) {
                    tmp = prisma.a3x.n_pmids
                    svgtxt = svgtxt.replace(
                        '$'+ref+'$', 
                        '' + jarvis.add_commas_to_number(tmp)
                    );
                }
                
            } 

            else if(ref == 'u5') {
                if(prisma.u5) {
                    tmp = prisma.u5.n_pmids
                    svgtxt = svgtxt.replace(
                        '$'+ref+'$', 
                        '' + jarvis.add_commas_to_number(tmp)
                    );
                }
                
            } 

            else if(ref == 'u4') {
                if(prisma.u4) {
                    tmp = prisma.u4.n_pmids
                    svgtxt = svgtxt.replace(
                        '$'+ref+'$', 
                        '' + jarvis.add_commas_to_number(tmp)
                    );
                }
                
            } 

            else if(ref == 'u6') {
                if(prisma.u6) {
                    tmp = prisma.u6.n_pmids
                    console.log("*************************************")
                    console.log(svgTxt)
                    console.log(ref)
                    console.log(tmp)
                    svgtxt = svgtxt.replace(
                        '$'+ref+'$', 
                        '' + jarvis.add_commas_to_number(tmp)
                    );
                }
                
            } 

            else if(ref == 'u7') {
                if(prisma.u7) {
                    tmp = prisma.u7.n_pmids
                    svgtxt = svgtxt.replace(
                        '$'+ref+'$', 
                        '' + jarvis.add_commas_to_number(tmp)
                    );
                }
                
            } 

            else if(ref == 'u8') {
                if(prisma.u8) {
                    tmp = prisma.u8.n_pmids
                    svgtxt = svgtxt.replace(
                        '$'+ref+'$', 
                        '' + jarvis.add_commas_to_number(tmp)
                    );
                }
                
            } 

            else if(ref == 'u9') {
                if(prisma.u9) {
                    tmp = prisma.u9.n_pmids
                    svgtxt = svgtxt.replace(
                        '$'+ref+'$', 
                        '' + jarvis.add_commas_to_number(tmp)
                    );
                }
                
            } 

            else if(ref == 'u10') {
                if(prisma.u10) {
                    tmp = prisma.u10.n_pmids
                    svgtxt = svgtxt.replace(
                        '$'+ref+'$', 
                        '' + jarvis.add_commas_to_number(tmp)
                    );
                }
                
            }

            else if(ref == 'u12') {
                if(prisma.u10) {
                    tmp = prisma.u12.n_pmids
                    svgtxt = svgtxt.replace(
                        '$'+ref+'$', 
                        '' + jarvis.add_commas_to_number(tmp)
                    );
                }
                
            }


            else if(ref == 'u13') {
                if(prisma.u13) {
                    tmp = prisma.u13.n_pmids
                    svgtxt = svgtxt.replace(
                        '$'+ref+'$', 
                        '' + jarvis.add_commas_to_number(tmp)
                    );
                }
                
            }


            else if(ref == 'u14') {
                if(prisma.u14) {
                    tmp = prisma.u14.n_pmids
                    svgtxt = svgtxt.replace(
                        '$'+ref+'$', 
                        '' + jarvis.add_commas_to_number(tmp)
                    );
                }
                
            }


            else if(ref == 'u15') {
                if(prisma.u15) {
                    tmp = prisma.u15.n_pmids
                    svgtxt = svgtxt.replace(
                        '$'+ref+'$', 
                        '' + jarvis.add_commas_to_number(tmp)
                    );
                }
                
            }

            else if(ref == 'a2x') {
                if(prisma.a2x) {
                    tmp = prisma.a2x.n_pmids
                    svgtxt = svgtxt.replace(
                        '$'+ref+'$', 
                        '' + jarvis.add_commas_to_number(tmp)
                    );
                }
                
            }

            else if(ref == 'u16') {
                if(prisma.u16) {
                    tmp = prisma.u16.n_pmids
                    svgtxt = svgtxt.replace(
                        '$'+ref+'$', 
                        '' + jarvis.add_commas_to_number(tmp)
                    );
                }
                
            }

            else if(ref == 'u17') {
                if(prisma.u17) {
                    tmp = prisma.u17.n_pmids
                    svgtxt = svgtxt.replace(
                        '$'+ref+'$', 
                        '' + jarvis.add_commas_to_number(tmp)
                    );
                }
                
            }


            else if(ref == 'u18') {
                if(prisma.u18) {
                    tmp = prisma.u18.n_pmids
                    svgtxt = svgtxt.replace(
                        '$'+ref+'$', 
                        '' + jarvis.add_commas_to_number(tmp)
                    );
                }
                
            }

            else if(ref == 'u19') {
                if(prisma.u19) {
                    tmp = prisma.u19.n_pmids
                    svgtxt = svgtxt.replace(
                        '$'+ref+'$', 
                        '' + jarvis.add_commas_to_number(tmp)
                    );
                }
                
            }

            else if(ref == 'u20') {
                if(prisma.u20) {
                    tmp = prisma.u20.n_pmids
                    svgtxt = svgtxt.replace(
                        '$'+ref+'$', 
                        '' + jarvis.add_commas_to_number(tmp)
                    );
                }
                
            }
            
          

            else {
                // what??? why none?
                svgtxt = svgtxt.replace(
                    '$'+ref+'$', 
                    'NA'
                );
            }
        }

        // write back to the svg
        document.getElementById('initial_prisma').innerHTML = svgtxt;
        


        // for the message boxes
        $( ".dialog" ).dialog({
            autoOpen: false
        });


        // bind the click event
        this.bind_events();
    },

    update_svg_by_year: function(yearValue, monthValue) {
        // const prismaAllData = prismaData;
        const prismaAllData = prismaData.monthly_prisma;
        const year = parseInt(yearValue);
        const month = parseInt(monthValue);

        // need to fix the e3 data
        const livingPrismaByMonth = prismaAllData[year][month];
        document.getElementById("initial_prisma").style.visibility = "visible";
        debugger
        // update the svg
        var refs = [
            'a1',
            'b2',
            'w1',
            'b3',
            'b5',
            's0',
            'e2', // exclude by title
            'e21', // exclude by rct 
            'e22', // exclude by abstract
            'e3',  // exclude by fulltext
            'f1',
            'f3'
        ];

        // replace the $$ with jquery findable tag
        var svgTxt;
        if(this.vpp.databasePrisma) {
            svgtxt = initialSvg;
        }
        else {
            svgtxt = livingSvg;
        }

        for (let i = 0; i < refs.length; i++) {
            const ref = refs[i];
            // update the number
            // replace the prisma title

            if (livingPrismaByMonth.hasOwnProperty(ref)) {
                // ok, found the value, 
                // the default value is from db
                var tmp = Math.abs(livingPrismaByMonth[ref].n);

                // for f1 and f3, also need to show the nct
                if (ref == 'f1') {
                    // do some math to f1
                    // the f1 should be those papers that:
                    // 1. in the 
                    // also need to update the ct id
                    livingPrismaByMonth[ref].n
                    svgtxt = svgtxt.replace(
                        '$'+ref+'_ctids$', 
                        '' + jarvis.add_commas_to_number(Math.abs(livingPrismaByMonth[ref].n))
                    );
                }

                if (ref == 'f3') {
                    // do some math to f3
                    // also need to update the ct id
                    livingPrismaByMonth[ref].n
                    svgtxt = svgtxt.replace(
                        '$'+ref+'_ctids$', 
                        '' + jarvis.add_commas_to_number(Math.abs(livingPrismaByMonth[ref].n))
                    );
                }

                // for others, need to update the number accordingly
                if (ref == 'b5') {
                    tmp = livingPrismaByMonth.a1.n ;
                          
                } else if (ref == 'a1') {
                    tmp = livingPrismaByMonth.a1.n ;
                          
                } else if (ref == 'b3') {
                    tmp = livingPrismaByMonth.a1.n 

                } else if (ref == 'b2') {
                    // tmp = livingPrismaByMonth.a1.n -(livingPrismaByMonth.e22.n + livingPrismaByMonth.e21.n);
                    tmp = livingPrismaByMonth.a1.n
                        - livingPrismaByMonth.e2.n   // by title
                        - livingPrismaByMonth.e22.n  // by abstract

                } else if (ref == 'e3') {
                    // tmp = livingPrismaByMonth.a1.n 
                    //     - (livingPrismaByMonth.e22.n + livingPrismaByMonth.e21.n) 
                    //     - Math.abs(livingPrismaByMonth.f1.n);
                    tmp = livingPrismaByMonth.a1.n
                        - livingPrismaByMonth.e2.n   // by title
                        - livingPrismaByMonth.e22.n  // by abstract
                        - livingPrismaByMonth.f1.n   // include in SR

                    // update the number
                    livingPrismaByMonth.e3.n = tmp;

                    // update the e3_by_reason
                    if (!livingPrismaByMonth.hasOwnProperty('e3_by_reason')) {
                        livingPrismaByMonth.e3_by_reason = {}
                    }

                    // sum all existing e3
                    let n_exist_e3 = 0;
                    for (const reason in livingPrismaByMonth.e3_by_reason) {
                        const _n = livingPrismaByMonth.e3_by_reason[reason].n;
                        n_exist_e3 += _n;
                    }

                    if (n_exist_e3 != livingPrismaByMonth.e3.n ) {
                        // which means there are hard to explain missing e3 reason:
                        // maybe not included in itable
                        // maybe not included in this cq
                        // maybe other, just just say other
                        livingPrismaByMonth.e3_by_reason['Other'] = {
                            n: livingPrismaByMonth.e3.n - n_exist_e3
                        };
                    }

                    
                } else if (ref == 'e2') {
                    // nothing, just e2
                }

                // update the value 
                svgtxt = svgtxt.replace(
                    '$'+ref+'$', 
                    '' + jarvis.add_commas_to_number(tmp)
                );

            } else if (ref == 'w1') {
                // special rule for screening studies
                // it is b2 - b3
                tmp = 
                    livingPrismaByMonth.a1.n ;

                svgtxt = svgtxt.replace(
                    '$'+ref+'$', 
                    '' + jarvis.add_commas_to_number(tmp)
                );
            } else if(ref == 'm1') {
                if(livingPrismaByMonth.a1) {
                    tmp = livingPrismaByMonth.a1.n
                    svgtxt = svgtxt.replace(
                        '$'+ref+'$', 
                        '' + jarvis.add_commas_to_number(tmp)
                    );
                }
            }
        }

        // use the updated data
        this.vpp.articlesList = livingPrismaByMonth;

        // write back to the svg
        document.getElementById('initial_prisma').innerHTML = svgtxt;
        
        // for the message boxes
        $( ".dialog" ).dialog({
            autoOpen: false
        });


        // bind the click event
        this.bind_events();
    },

    bind_events: function() {
        var self = this; 
        $('svg a').on('click', function(evt) {
            var link = $(this).attr('xlink:href');
            console.log("* clicked: " + link);
            
            // click the studylist link
            var ps = link.split('_');
            var stage = ps[1];

            if (stage == 'f1') {
                if (self.vpp.databasePrisma) {
                    // in fact this is f2!
                    app_prisma.set_stage('f2');
                } else {
                    app_prisma.set_stage(stage);
                }

            } else if (stage == 'f3') {
                app_prisma.set_stage(stage);

            } else if (stage == 'f2') {
                app_prisma.set_stage(stage);
            
            } else if (stage == 'e3') {
                document.getElementById('e3-close-dialogue').style.visibility = 'visible';
                //$( "#dialog-message-e3" ).dialog( "open" );
            } else if ( stage == 'a3x') {
                app_prisma.showManualArticlesList('a3x');
            }

            // decide what to do with op
            // if (op == 'sch') {
            //     // clicked the search item
            //     // update the PRISMA plot
            //     jarvis.update_prisma(sn);

            // } else if (op == 'cnt') {
            //     // clicked the number
            //     // update the study list
            //     if (sn == 'xx') {
            //         // clicked the cell in the PRISMA plot
            //         tb_studylist.update_study_list(jarvis.current.sn, stage);

            //     } else {
            //         // update plot
            //         jarvis.update_prisma(sn);

            //         // update list
            //         tb_studylist.update_study_list(sn, stage);
            //     }
            // }
            // return false;
        });
        // 
        // $('.initial-prisma').on('click', function() {
        //     self.vpp.showDatabasePrisma();
        // });
        // $('.living-prisma').on('click', function() {
        //     self.vpp.showResearchedPrisma();
        // });
        // $('.custom-prisma').on('click', function() {
        //     self.vpp.showCustomPrisma();
        // });
        // $('#e3-close-button').on('click', function() {
        //    self.vpp.closeE3Dialogue();
        //});
    },

    unpack: function(rows, key) {
        return rows.map(function(row) {
            return row[key];
        });
    },

    clear: function() {
        this.vpp.n = 0;
        this.vpp.headers = [];
        this.vpp.studies = [];
    },

    set_stage: function(stage) {
        this.data.prisma = prismaData.prisma;
        if(this.vpp.databasePrisma) {
            // set the stage
            this.vpp.stage = stage;

            // put the papers in this stage
            var studies = [];
            for (var i = 0; i < this.data.prisma[stage].paper_list.length; i++) {
                var pmid = this.data.prisma[stage].paper_list[i];
                var paper = this.data.paper_dict[pmid];
                var ctid = paper.ctid;

                if (paper.hasOwnProperty('title')) {
                    // this paper is a real PMID data or we put data in xls
                    studies.push(paper);
                } else {
                    studies.push(this.data.study_dict[ctid]);
                }
            }
            this.vpp.monthlyPaperListFlag = false;
            this.vpp.studies = studies;
            this.vpp.total = studies.length;
            console.log('* set vpp studies', studies);

        } else {
            const year = parseInt(prismaYearFilter);
            const month = parseInt(prismaMonthFilter);
            // set the stage
            this.vpp.stage = stage;

            // put the papers in this stage
            // var studies = [];
            // if(this.data.monthly_prisma[year][month][stage].paper_list) {
            //     for (var i = 0; i < this.data.monthly_prisma[year][month][stage].paper_list.length; i++) {
            //         var pmid = this.data.prisma[stage].paper_list[i];
            //         var paper = this.data.paper_dict[pmid];
            //         var ctid = paper.ctid;

            //         if (paper.hasOwnProperty('title')) {
            //             // this paper is a real PMID data or we put data in xls
            //             studies.push(paper);
            //         } else {
            //             studies.push(this.data.study_dict[ctid]);
            //         }
            //         this.vpp.studies = studies;
            //         this.vpp.total = studies.length;
            //         console.log('* set vpp studies', studies);
            //     }
            // }
            // else {
            //     this.vpp.monthlyPaperListFlag = true;
            // }

        }
    },

    showManualArticlesList: function(stage) {
        this.vpp.stage = stage;
    },

    showE3Reasons: function () {
        
    },

    set_stage_to_nct_latest: function(stage) {
        // set the stage
        this.vpp.stage = stage;

        // put the papers in this stage
        var studies = [];
        for (var i = 0; i < this.data.prisma[stage].study_list.length; i++) {
            var ctid = this.data.prisma[stage].study_list[i];
            var latest_pmid = this.data.study_dict[ctid].latest_pmid;
            var paper = this.data.paper_dict[latest_pmid];

            if (paper.hasOwnProperty('title')) {
                // this paper is a real PMID data or we put data in xls
                studies.push(paper);
            } else {
                studies.push(this.data.study_dict[ctid]);
            }
        }
        this.vpp.studies = studies;
        this.vpp.total = studies.length;
        console.log('* set vpp studies', studies);
    },

    get_summary_of_search_results: function(ids, callback) {
        $.get(
            jarvis.url.pubmed.esummary,
            {id: ids.join(',')},
            callback, 'xml'
        );
    },

    parse_summary_results: function(data) {
        var xml = $(data);
        var docsums = xml.find('DocSum');
        
        for (var i = 0; i < docsums.length; i++) {
            var docsum_xml = $(docsums[i]);

            // get PMID
            var pmid = docsum_xml.find('Id')[0].textContent;

            // get title
            var title = docsum_xml.find('Item[Name="Title"]')[0].textContent;

            // get authors
            var authors = [];
            var authors_elems = docsum_xml.find('Item[Name="Author"]');
            for (var j = 0; j < authors_elems.length; j++) {
                var elem = authors_elems[j];
                authors.push(elem.textContent);
            }

            // get journal
            var journal = docsum_xml.find('Item[Name="FullJournalName"]')[0].textContent;

            // get date
            var date = docsum_xml.find('Item[Name="PubDate"]')[0].textContent;

            // update the record
            this.data.paper_dict[pmid].title = title;
            this.data.paper_dict[pmid].date = date;
            this.data.paper_dict[pmid].journal = journal;
            this.data.paper_dict[pmid].authors = authors.join(', ');
        }
    }
};


var jarvis = {
    data: null,

    init: function() {

        // OK, let's get the project key first
        var prj = jarvis.get_url_paramter('prj');
        if (prj == null || prj == '') {
            jarvis.ssmsg('Project information error.')
            return;
        }

        // get the cq_abbr for this project
        var cq = jarvis.get_url_paramter('cq');
        if (cq == null || cq == '') {
            cq = 'default';
        }

        // where to get the data
        var src = jarvis.get_url_paramter('src');
        if (src == '') {
            src = 'db';
        }

        var version = jarvis.get_url_paramter('version');
        if (version == '') {
            version = '';
        }

        // send request to get data for initializing app
        var url = "[[ url_for('pub.graphdata', keystr='__KEYSTR__', fn='PRISMA.json') ]]";
        // update with url with the project keystr
        url = url.replace('__KEYSTR__', prj);

        $.get(
            // '/pub/graphdata/' + prj + '/PRISMA.json',
            url,
            {
                src: src,
                cq: cq,
                ver: Math.random(),
                version: version
            },
            function(data) {
                debugger;
                prismaData = data;
                prismaYearDropdownOptions = Object.keys(data.monthly_prisma);

                for (const year of prismaYearDropdownOptions) {
                    prismaMonthDropdownOptions[year] = Object.keys(data.monthly_prisma[year]);
                }

                for (let i = 0; i < prismaYearDropdownOptions.length; i++) {
                    var option = document.createElement("option");
                    option.value = prismaYearDropdownOptions[i];
                    option.text = prismaYearDropdownOptions[i];
                    yearDropdown.appendChild(option);
                }
                app_prisma.init(data);
                
                // update the e2 detail
                // var e2_details = data.prisma.e2.detail;
                // e2_details = '<p>'+e2_details+'</p>';
                // $('#dialog-message-e2').html(e2_details);

                // OK!
                jarvis.ssmsg('Data loaded!');
                setTimeout('jarvis.ssclose();', 300);

            }, 'json'
        );

    },

    ssmsg: function(msg) {
        $('#ss-msg').html(msg);
    },

    ssclose: function() {
        $('#start-screen').hide();
    }
};
{% include 'js/jarvis_ext_utils.js' %}

$(document).ready(function() {
    jarvis.init();
})
function callUpdateSvgYear(value) {
    let monthDropdown = document.getElementById("month-selected");
    prismaYearFilter = value;
    monthDropdown.innerHTML = '';
    monthDropdown.innerHTML = '<option value="" selected >Select Month</option>'
    for (let month of prismaMonthDropdownOptions[value]) {
        var monthOption = document.createElement("option");
        monthOption.value = month;
        monthOption.text = getMonthName(month);
        monthDropdown.appendChild(monthOption);
    }
}
function callUpdateSvgMonth(value) {
    if(prismaYearFilter) {
        prismaMonthFilter = value;
        articlesList = prismaData.monthly_prisma[prismaYearFilter][prismaMonthFilter]
        app_prisma.update_svg_by_year(prismaYearFilter, prismaMonthFilter);
    }
    else {
        alert('Please select Year');
    }
}
function getMonthName(monthNumber) {
    const months = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
    return months[parseInt(monthNumber, 10) - 1];
}

</script>
</body>
</html>